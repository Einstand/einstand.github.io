<html>
<style>
PRE
{
	font-family:verdana,arial,helvetica;
  font-size:10pt;
  line-height:12pt;
	margin-left:20px;
  padding:8px 8px;
  background-color:#EEE;
}
</style>
<body>
<h2>使用 GitLab 的 CI 時, 如何存取另一個 Private Repository</h2>
分為兩種情形
<ul>
  <li>第一種是使用個人帳號</li>
  <li>第二種是使用企業帳號</li>
</ul>


<h3>使用個人帳號的情形</h3>
<p>這種情況比較單純, 簡言之就是使用 <b>CI_JOB_TOKEN</b> 去讀取同帳號下的另一個 Repository, 範例如下</p>

<code>git clone https://gitlab-ci-token:${CI_JOB_TOKEN}@gitlab.com/&lt;user&gt;/&lt;mydependentrepo&gt;.git</code>

<p>詳情可參考 <a href='https://stackoverflow.com/questions/59508583/download-another-private-repository-from-gitlab-ci-with-same-author'>Download another private repository from gitlab CI with same author</a> 這裡不多做解譯</p>

<h3>使用企業帳號的情形</h3>
<p>使用企業帳號時, 每個 Project 的上層還有 Group, Group 的上層還可能有另一個 Group</p>

<p>假設現在有一個 Project 為 <b>git@gitlab.com:ntsft/prod-main/Einstand-Submodule-Test.git</b></p>

<p>那 <i>Einstand-Submodule-Test</i> 這個 Project 就屬於 <i>ntsft</i> Group 之下的 <i>prod-main</i> SubGroup</p>

<p>現在我們要引用另一個 Project <b>git@gitlab.com:ntsft/prod-main/einstand-golib.git</b> 中的程式碼</p>

<p>首先, 將 <b>git@gitlab.com:ntsft/prod-main/Einstand-Submodule-Test.git</b> 下載到 Local 硬碟上</p>

<code>git clone git@gitlab.com:ntsft/prod-main/Einstand-Submodule-Test.git</code>

<p>我是存放在 D:\Repo_ntsft_prod-main\Einstand-Submodule-Test 目錄裡</p>

<p>然後到 D:\Repo_ntsft_prod-main\Einstand-Submodule-Test 目錄裡開啟 Dos-Prompt 然後執行</p>

<code>git submodule add git@gitlab.com:ntsft/prod-main/einstand-golib.git</code>

<p>上述目錄就就會多出一個 .gitmodules 的檔案, 和一個 einstand-golib 次目錄. 然後 commit 到 GitLab Server</p>
<p>再到 GitLab 的 Einstand-Submodule-Test Project 裡去看</p>
<img alt="2020-09-19_164030" width="960" height="46" src="data:image/png;base64,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">
<p>可以發現 einstand-golib 這個目錄並沒有真的上傳, 而是標記為 f8d02cf2 的連結, 按下去就會跑到 einstand-golib Project 去</p>

<p>接下來,我們參考 <a href='https://stackoverflow.com/questions/25689231/getting-gitlab-ci-to-clone-private-repositories'>Getting GitLab CI to clone private repositories</a> 裡的方法, 修改 .gitlab-ci.yml</p>
<table border=1>
  <tr>
    <td>修改前</td>
    <td>修改後</td>
  </tr>
  <tr>
  <td valign="top">
<pre>
image: golang:latest

variables:
  # Please edit to your GitLab project
  REPO_NAME: gitlab.com/ntsft/prod-main/Einstand-Submodule-Test
  
# The problem is that to be able to use go get, one needs to put
# the repository in the $GOPATH. So for example if your gitlab domain
# is gitlab.com, and that your repository is namespace/project, and
# the default GOPATH being /go, then you'd need to have your
# repository in /go/src/gitlab.com/namespace/project
# Thus, making a symbolic link corrects this.
before_script:
  - mkdir -p $GOPATH/src/$(dirname $REPO_NAME)
  - ln -svf $CI_PROJECT_DIR $GOPATH/src/$REPO_NAME
  - cd $GOPATH/src/$REPO_NAME

stages:
  - test
  - build
  - deploy

format:
  stage: test
  script:
    - go fmt $(go list ./... | grep -v /vendor/)
    - go vet $(go list ./... | grep -v /vendor/)
    - go test -race $(go list ./... | grep -v /vendor/)

compile:
  stage: build
  script:
    - go build -race -ldflags "-extldflags '-static'" -o $CI_PROJECT_DIR/mybinary
  artifacts:
    paths:
      - mybinary
</pre>
  </td>
  <td>
<pre>
image: golang:latest

variables:
  # Please edit to your GitLab project
  REPO_NAME: gitlab.com/ntsft/prod-main/Einstand-Submodule-Test
  GIT_SUBMODULE_STRATEGY: recursive
  
# The problem is that to be able to use go get, one needs to put
# the repository in the $GOPATH. So for example if your gitlab domain
# is gitlab.com, and that your repository is namespace/project, and
# the default GOPATH being /go, then you'd need to have your
# repository in /go/src/gitlab.com/namespace/project
# Thus, making a symbolic link corrects this.
before_script:
  - git submodule init
  - git submodule update
  - pwd
  - ls
  - mkdir -p $GOPATH/src/$(dirname $REPO_NAME)
  - ln -svf $CI_PROJECT_DIR $GOPATH/src/$REPO_NAME
  - cd $GOPATH/src/$REPO_NAME

stages:
  - test
  - build
  - deploy

format:
  stage: test
  script:
    - go fmt $(go list ./... | grep -v /vendor/)
    - go vet $(go list ./... | grep -v /vendor/)
    - go test -race $(go list ./... | grep -v /vendor/)

compile:
  stage: build
  script:
    - go build -race -ldflags "-extldflags '-static'" -o $CI_PROJECT_DIR/mybinary
  artifacts:
    paths:
      - mybinary
</pre>
  </td>
</tr>
</table>
<p>就是在 variables: 區, 加上 GIT_SUBMODULE_STRATEGY: recursive</p>
<p>就是在 before_script: 區, 加上</p>
<pre>
  - git submodule init
  - git submodule update
  - pwd
  - ls
</pre>
然後 commit<br>

這時會錯.
<pre>
Initialized empty Git repository in /builds/ntsft/prod-main/Einstand-Submodule-Test/.git/
Created fresh repository.
Checking out 58a03c74 as master...
Updating/initializing submodules recursively...
Submodule 'einstand-golib' (git@gitlab.com:ntsft/prod-main/einstand-golib.git) registered for path 'einstand-golib'
Cloning into '/builds/ntsft/prod-main/Einstand-Submodule-Test/einstand-golib'...
error: cannot run ssh: No such file or directory
fatal: unable to fork
fatal: clone of 'git@gitlab.com:ntsft/prod-main/einstand-golib.git' into submodule path '/builds/ntsft/prod-main/Einstand-Submodule-Test/einstand-golib' failed
Failed to clone 'einstand-golib'. Retry scheduled
Cloning into '/builds/ntsft/prod-main/Einstand-Submodule-Test/einstand-golib'...
error: cannot run ssh: No such file or directory
fatal: unable to fork
fatal: clone of 'git@gitlab.com:ntsft/prod-main/einstand-golib.git' into submodule path '/builds/ntsft/prod-main/Einstand-Submodule-Test/einstand-golib' failed
Failed to clone 'einstand-golib' a second time, aborting
ERROR: Job failed: exit code 1
</pre>

<p>我們再修改 .gitmodules 這個檔案</p>
<table border=1>
  <tr>
    <td>修改前</td>
    <td>修改後</td>
  </tr>
  <tr>
    <td>
<pre>
[submodule "einstand-golib"]
   path = einstand-golib
   url = git@gitlab.com:ntsft/prod-main/einstand-golib.git
</pre>
    </td>
    <td>
<pre>
[submodule "einstand-golib"]
   path = einstand-golib
   url = ../../prod-main/einstand-golib.git
</pre>
    </td>
  </tr>
</table>
然後 commit<br>


<pre>
Initialized empty Git repository in /builds/ntsft/prod-main/Einstand-Submodule-Test/.git/
Created fresh repository.
Checking out 6eaf2e25 as master...
Updating/initializing submodules recursively...
Submodule 'einstand-golib' (https://gitlab-ci-token:[MASKED]@gitlab.com/ntsft/prod-main/einstand-golib.git) registered for path 'einstand-golib'
Cloning into '/builds/ntsft/prod-main/Einstand-Submodule-Test/einstand-golib'...
Submodule path 'einstand-golib': checked out 'f8d02cf2fe40c64beb179d1c0763b8625bee019f'
Entering 'einstand-golib'
Executing "step_script" stage of the job script
00:15
$ git submodule init
$ git submodule update
$ pwd
/builds/ntsft/prod-main/Einstand-Submodule-Test
$ ls
README.md
commit.bat
einstand-golib
gitmodules.bak
go.mod
go.sum
main.go
</pre>
<p>就對了</p>

<p>我們再修改 .gitlab-ci.yml 裡的 before_script 將 einstand-golib 的內容複製到 GOROOT 裡</p>
<table border=1>
  <tr>
    <td>修改前</td>
    <td>修改後</td>
  </tr>
  <tr>
    <td valign='top'>
<pre>
before_script:
  - git submodule init
  - git submodule update
  - pwd
  - ls
  - mkdir -p $GOPATH/src/$(dirname $REPO_NAME)
  - ln -svf $CI_PROJECT_DIR $GOPATH/src/$REPO_NAME
  - cd $GOPATH/src/$REPO_NAME
  - pwd
</pre>
    </td>
    <td>
<pre>
before_script:
  - git submodule init
  - git submodule update
  - pwd
  - ls
  - cp -r einstand-golib /usr/local/go/src/einstand
  - ls /usr/local/go/src/einstand
  - mkdir -p $GOPATH/src/$(dirname $REPO_NAME)
  - ln -svf $CI_PROJECT_DIR $GOPATH/src/$REPO_NAME
  - cd $GOPATH/src/$REPO_NAME
  - pwd
</pre>
    </td>
  </tr>
</table>

</body>
</html>